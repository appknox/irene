<AkBreadcrumbs::AutoTrail />

<AkTypography @variant='h5' class='mt-3'>
  {{this.title}}
</AkTypography>

<AkStack
  @justifyContent='space-between'
  @alignItems='center'
  class='mt-3'
  local-class='query-container'
>
  <AkStack @direction='column' @spacing={{1}}>
    <AkTypography @variant='h6'>
      {{t 'reportModule.reportQuery'}}
    </AkTypography>

    <AkTypography>
      {{@reportRequest.query}}
    </AkTypography>
  </AkStack>
</AkStack>

<div local-class='preview-container' class='mt-3'>
  {{#if this.hasDefaultFilters}}
    <AkStack @alignItems='center' local-class='default-filter-note'>
      <div local-class='warning-icon-container'>
        <AkIcon @iconName='warning' />
      </div>

      <AkTypography class='ml-1'>
        {{t 'reportModule.defaultFilter'}}
      </AkTypography>
    </AkStack>
  {{/if}}

  <AkStack
    @direction='row'
    @justifyContent='space-between'
    @alignItems='center'
    class='p-2'
  >
    <AkStack @spacing='1.5'>
      <AkButton
        @variant='filled'
        @disabled={{not @reportRequest.isRelevant}}
        @color='primary'
        {{on 'click' this.handleFilterByColumnDrawerOpen}}
        local-class='custom-button {{if
          (not @reportRequest.isRelevant)
          "disabled"
        }}'
      >
        <:leftIcon>
          <AkIcon
            @iconName='filter-list'
            @color={{if @reportRequest.isRelevant 'primary' 'inherit'}}
          />
        </:leftIcon>

        <:default>
          {{t 'reportModule.filterByColumns'}}

          {{#if @reportRequest.isRelevant}}
            -&nbsp;
            <strong>{{this.noSelectedColumns}}</strong>
          {{/if}}
        </:default>
      </AkButton>

      <AkButton
        @variant='filled'
        @disabled={{not @reportRequest.isRelevant}}
        @color='primary'
        {{on 'click' this.handleAdvanceFilterDrawerOpen}}
        local-class='custom-button {{if
          (not @reportRequest.isRelevant)
          "disabled"
        }}'
      >
        <:leftIcon>
          <AkIcon
            @iconName='add'
            @color={{if @reportRequest.isRelevant 'primary' 'inherit'}}
          />
        </:leftIcon>

        <:default>
          {{t 'reportModule.advanceFilter'}}
        </:default>
      </AkButton>
    </AkStack>

    <AkButton
      @disabled={{not @reportRequest.isRelevant}}
      @loading={{or this.fetchDownloadUrl.isRunning this.isGenerating}}
      {{on 'click' (perform this.fetchDownloadUrl)}}
    >
      {{if
        this.isGenerating
        (t 'reportModule.generating')
        (t 'downloadReport')
      }}
    </AkButton>
  </AkStack>

  <AkDivider @color='dark' />

  <div class='p-2' local-class='report-preview'>
    {{#if this.previewReportRequest.isRunning}}
      <AkTable::Loading />
    {{else if this.hasPreviewData}}
      <AkPaginationProvider
        @results={{this.rows}}
        @onItemPerPageChange={{this.handleItemPerPageChange}}
        @totalItems={{this.totalRows}}
        @nextAction={{this.handleNextPrevAction}}
        @prevAction={{this.handleNextPrevAction}}
        @itemPerPageOptions={{array 10 25 50}}
        @defaultLimit={{this.limit}}
        @offset={{this.offset}}
        local-class='report-preview-table-container'
        as |pgc|
      >
        <AkTable
          local-class='report-preview-table'
          @variant='full-bordered'
          as |t|
        >
          <t.head
            @columns={{this.columns}}
            @scrollIndicators='horizontal'
            @columnKeyPath='val_field'
          />

          <t.body @rows={{pgc.currentPageResults}} @renderAll={{true}} as |b|>
            <b.row as |r|>
              <r.cell>
                {{#if r.columnValue.component}}
                  {{#let (component r.columnValue.component) as |Component|}}
                    <Component
                      @column={{r.columnValue}}
                      @value={{r.rowValue}}
                    />
                  {{/let}}
                {{/if}}
              </r.cell>
            </b.row>
          </t.body>
        </AkTable>

        <AkPagination
          @disableNext={{pgc.disableNext}}
          @nextAction={{pgc.nextAction}}
          @disablePrev={{pgc.disablePrev}}
          @prevAction={{pgc.prevAction}}
          @endItemIdx={{pgc.endItemIdx}}
          @startItemIdx={{pgc.startItemIdx}}
          @itemPerPageOptions={{pgc.itemPerPageOptions}}
          @onItemPerPageChange={{pgc.onItemPerPageChange}}
          @selectedOption={{pgc.selectedOption}}
          @tableItemLabel={{t 'exports'}}
          @perPageTranslation={{t 'recordPerPage'}}
          @totalItems={{pgc.totalItems}}
        />
      </AkPaginationProvider>
    {{else}}
      <AkStack
        @direction='column'
        @alignItems='center'
        @justifyContent='center'
        {{style height='500px'}}
      >
        <AkSvg::NoApisCaptured class='mt-3' />

        <AkStack
          @direction='column'
          @alignItems='center'
          @spacing='1'
          class='mt-3'
        >
          <AkTypography @align='center' @variant='h5'>
            {{this.errorScreenHeader}}
          </AkTypography>

          <AkTypography @align='center' {{style maxWidth='400px'}}>
            {{this.errorScreenDesc}}
          </AkTypography>
        </AkStack>
      </AkStack>
    {{/if}}
  </div>
</div>

<AiReporting::Preview::FilterByColumnDrawer
  @open={{this.filterByColumnDrawerOpen}}
  @onClose={{this.handleFilterByColumnDrawerClose}}
  @onApply={{this.handleFilterByColumnDrawerApply}}
  @allColumnsMap={{this.allColumnsMap}}
/>

<AiReporting::Preview::AdvanceFilterDrawer
  @open={{this.advanceFilterDrawerOpen}}
  @onClose={{this.handleAdvanceFilterDrawerClose}}
  @onApply={{this.handleAdvanceFilterDrawerApply}}
  @filterDetails={{this.filterDetails}}
  @additionalFilters={{this.additionalFilters}}
/>

{{#if this.downloadUrl}}
  <AiReporting::Preview::IframeWrapper
    @name='download-frame'
    @downloadUrl={{this.downloadUrl}}
    @onDownloadReset={{this.handleDownloadReset}}
    as |initDownload|
  >
    <form
      id='download-form'
      method='POST'
      target='download-frame'
      {{did-insert initDownload}}
    >
      <input type='hidden' name='title' value='' />
      <input type='hidden' name='columns' value={{this.downloadColumns}} />
      <input type='hidden' name='report_type' value='' />
      <input
        type='hidden'
        name='additional_filters'
        value={{this.downloadAdditionalFilters}}
      />
    </form>
  </AiReporting::Preview::IframeWrapper>
{{/if}}