<div local-class='sso-settings-main-container'>
  <AkTypography
    data-test-ssoSettings-desc
    class='pb-2'
    @variant='body2'
    @color='textSecondary'
  >
    {{t 'samlDesc'}}
  </AkTypography>

  <div local-class='bordered-box'>
    <div class='p-2'>
      <AkTypography data-test-ssoSettings-spTitle @variant='subtitle1'>
        {{t 'serviceProvider'}}
      </AkTypography>

      <AkTypography
        data-test-ssoSettings-spDesc
        @variant='body2'
        @color='textSecondary'
      >
        {{t 'spMetadataDesc'}}
      </AkTypography>
    </div>

    <AkDivider class='my-0' @color='dark' />

    <AkStack @alignItems='flex-end' @justifyContent='space-between'>
      <AkRadio::Group
        class='mx-2 mt-2'
        @groupDirection='row'
        @value={{this.spConfig}}
        @onChange={{this.handleSpConfigChange}}
        as |ctx|
      >
        <AkFormControlLabel @label={{t 'manualSettings'}}>
          <AkRadio
            data-test-ssoSettings-spConfigRadioManual
            @radioCtx={{ctx}}
            @value='manual'
          />
        </AkFormControlLabel>

        <AkFormControlLabel class='ml-3' @label={{t 'xmlMetadata'}}>
          <AkRadio
            data-test-ssoSettings-spConfigRadioXml
            @radioCtx={{ctx}}
            @value='xml'
          />
        </AkFormControlLabel>
      </AkRadio::Group>

      {{#if this.spConfigIsXml}}
        <AkClipboard as |ac|>
          <AkIconButton
            data-test-ssoSettings-spConfigCopyBtn
            class='mr-2'
            @variant='outlined'
            data-clipboard-text={{this.spMetadata.metadata}}
            id={{ac.triggerId}}
          >
            <AkIcon
              @variant='outlined'
              @color='info'
              @iconName='content-copy'
            />
          </AkIconButton>
        </AkClipboard>
      {{/if}}
    </AkStack>

    {{#if this.spConfigIsManual}}
      <div class='m-2'>
        <div local-class='bordered-box'>
          {{#each this.spMetadataKeys as |smk|}}
            <AkStack local-class='full-bordered-box-section'>
              <div
                class='w-4/12'
                local-class='full-bordered-box-section-column'
              >
                <AkTypography
                  data-test-ssoSettings-spConfigLabel
                  @variant='subtitle2'
                >
                  {{t smk.labelKey}}
                </AkTypography>
              </div>

              <div
                class='w-8/12'
                local-class='full-bordered-box-section-column'
              >
                <AkTypography
                  data-test-ssoSettings-spConfigValue
                  @variant='body2'
                  @color='textSecondary'
                >
                  {{get this.spMetadata smk.valueKey}}
                </AkTypography>
              </div>
            </AkStack>
          {{/each}}
        </div>
      </div>

    {{else if this.spConfigIsXml}}
      <div class='m-2'>
        <Textarea
          data-test-ssoSettings-spConfigXmlInput
          id='sp-config-xml-input'
          local-class='textarea-input'
          rows='8'
          disabled={{true}}
          @value={{this.spMetadata.metadata}}
        />
      </div>
    {{/if}}
  </div>

  <div class='mt-3' local-class='bordered-box'>
    <div local-class='bordered-box-section'>
      <AkTypography data-test-ssoSettings-idpTitle @variant='subtitle1'>
        {{t 'identityProvider'}}
      </AkTypography>
    </div>

    {{#if @idpMetadata}}
      <SsoSettings::Saml::IdpMetadata
        @idpMetadata={{@idpMetadata}}
        @sso={{@sso}}
        @openDeleteIdpMetadataConfirm={{this.openDeleteIdpMetadataConfirm}}
      />
    {{else}}
      {{#if this.idpMetadataXml}}
        <div class='p-2'>
          <AkTypography @variant='body2' @color='textSecondary'>
            {{t 'idpMetadataEdit'}}
          </AkTypography>
        </div>

        <AkDivider class='my-0' @color='dark' />

        <form class='p-2' {{on 'submit' (perform this.uploadIdPMetadata)}}>
          <Textarea
            data-test-ssoSettings-idpMetadataXmlInput
            id='idp-metadata-xml-input'
            local-class='textarea-input'
            rows='10'
            placeholder='IdP Metadata XML Content'
            @value={{this.idpMetadataXml}}
          />

          <AkStack class='mt-2' @spacing='1.5'>
            <AkButton
              data-test-ssoSettings-idpMetadataXmlSubmitBtn
              @type='submit'
              @loading={{this.uploadIdPMetadata.isRunning}}
            >
              {{t 'upload'}}
            </AkButton>

            <AkButton
              data-test-ssoSettings-idpMetadataXmlCancelBtn
              @variant='outlined'
              @color='neutral'
              @disabled={{this.uploadIdPMetadata.isRunning}}
              {{on 'click' this.cancelIdpMetadataXmlUpload}}
            >
              {{t 'cancel'}}
            </AkButton>
          </AkStack>
        </form>
      {{else}}
        <div class='p-2'>
          <AkTypography
            data-test-ssoSettings-idpUploadText
            @variant='body2'
            @color='textSecondary'
          >
            {{t 'idpMetadataUpload'}}
          </AkTypography>
        </div>

        <AkDivider class='my-0' @color='dark' />

        {{#if this.parseIdpMetadataXml.isRunning}}
          <AkStack @alignItems='center' @justifyContent='center'>
            <AkStack
              data-test-ssoSettings-idpUploadFileProcessing
              class='p-5'
              @alignItems='center'
              @justifyContent='center'
              @spacing='1.5'
            >
              <AkLoader @size={{14}} />
              <AkTypography>{{t 'processing'}}</AkTypography>
            </AkStack>
          </AkStack>
        {{else}}
          {{#let
            (file-queue
              name='uploadIdpMetadataXml'
              onFileAdded=(perform this.parseIdpMetadataXml)
            )
            as |queue|
          }}
            <FileDropzone @queue={{queue}} as |dropzone|>
              {{#if dropzone.supported}}
                <AkStack
                  @direction='column'
                  @alignItems='center'
                  @justifyContent='center'
                  @spacing='2'
                  class='p-2'
                  local-class='{{if dropzone.active "dropzone-upload-active"}}'
                >
                  <img
                    data-test-ssoSettings-idpUploadFileIcon
                    width='32'
                    src='/images/xml.svg'
                    alt='xml'
                  />

                  <AkStack
                    data-test-ssoSettings-idpUploadFileDragDropText
                    @alignItems='center'
                    @spacing='1'
                  >
                    <AkIcon @color='textPrimary' @iconName='file-upload' />

                    <AkTypography>
                      {{t 'dragDropFile'}}
                    </AkTypography>

                    <AkTypography @color='textSecondary'>
                      {{t 'or'}}
                    </AkTypography>
                  </AkStack>

                  <label
                    data-test-ssoSettings-idpUploadFileBtn
                    local-class='browse-file-btn'
                  >
                    {{t 'browseFiles'}}

                    <input
                      data-test-ssoSettings-idpUploadFileInput
                      type='file'
                      id='upload-idp-metadata-xml-file-input'
                      accept='text/xml'
                      {{style display='none'}}
                      {{queue.selectFile}}
                    />
                  </label>
                </AkStack>
              {{/if}}
            </FileDropzone>
          {{/let}}
        {{/if}}
      {{/if}}
    {{/if}}
  </div>
</div>

{{#if this.showSsoToggle}}
  <SsoSettings::SsoToggle @organization={{@organization}} @user={{@user}} />
{{/if}}

<ConfirmBox
  @isActive={{this.showDeleteIdpMetadataConfirm}}
  @description={{t 'confirmBox.deleteIdpConfig'}}
  @delegate={{this}}
  @confirmAction={{perform this.deleteIdpConfig}}
  @confirmText={{t 'delete'}}
  @disabled={{this.deleteIdpConfig.isRunning}}
/>