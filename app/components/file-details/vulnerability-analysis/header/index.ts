import Component from '@glimmer/component';
import { service } from '@ember/service';

import ENUMS from 'irene/enums';
import styles from './index.scss';
import type FileModel from 'irene/models/file';
import type IreneAjaxService from 'irene/services/ajax';
import type MeService from 'irene/services/me';

export interface FileDetailsVulnerabilityAnalysisHeaderSignature {
  Args: {
    file: FileModel;
    filterVulnerabilityType: string | number;
    setVulnerabilityType: (vulnerabilityType: number) => void;
  };
}

export default class FileDetailsVulnerabilityAnalysisHeaderComponent extends Component<FileDetailsVulnerabilityAnalysisHeaderSignature> {
  @service declare ajax: IreneAjaxService;
  @service declare me: MeService;

  get classes() {
    return {
      vulnerabilityTypeFilterSelectTrigger:
        styles['vulnerability-type-filter-select-trigger'],
    };
  }

  get isManualScanDisabled() {
    return !this.args.file.project?.get('isManualScanAvailable');
  }

  get isSecurityEnabled() {
    return this.me.org?.has_security_permission;
  }

  get vulnerabilityTypes() {
    const manualType = ENUMS.VULNERABILITY_TYPE.MANUAL;
    const types = ENUMS.VULNERABILITY_TYPE.CHOICES.slice(0, -1);

    const options = [
      ENUMS.VULNERABILITY_TYPE.UNKNOWN,
      ...types.map(({ value }) => value),
    ] as number[];

    return this.isManualScanDisabled
      ? options.filter((type) => type !== manualType)
      : options;
  }
}

declare module '@glint/environment-ember-loose/registry' {
  export default interface Registry {
    'FileDetails::VulnerabilityAnalysis::Header': typeof FileDetailsVulnerabilityAnalysisHeaderComponent;
  }
}
