import { inject as service } from '@ember/service';
import { htmlSafe } from '@ember/template';
import { isEmpty } from '@ember/utils';
import Component from '@glimmer/component';
import IntlService from 'ember-intl/services/intl';

import AnalysisModel from 'irene/models/analysis';

export interface FileDetailsVulnerabilityAnalysisDetailsSignature {
  Args: {
    analysis: AnalysisModel;
  };
}

export default class FileDetailsVulnerabilityAnalysisDetailsComponent extends Component<FileDetailsVulnerabilityAnalysisDetailsSignature> {
  @service declare intl: IntlService;

  get breadcrumbItems() {
    const fileId = this.args.analysis.file.get('id');
    const analysisId = this.args.analysis.id;

    return [
      {
        route: 'authenticated.dashboard.projects',
        linkTitle: this.intl.t('allProjects'),
      },
      {
        route: 'authenticated.dashboard.file',
        linkTitle: this.intl.t('scanDetails'),
        models: [fileId as string],
      },
      {
        route: 'authenticated.dashboard.file.analysis',
        linkTitle: this.intl.t('vulnerabilityDetails'),
        models: [fileId as string, analysisId],
      },
    ];
  }

  get analysis() {
    return this.args.analysis || null;
  }

  get owaspMobile2024Exists() {
    return !isEmpty(this.analysis.owaspmobile2024.toArray());
  }

  get pcidssExists() {
    return !isEmpty(this.analysis.pcidss.toArray());
  }

  get regulatoryContent() {
    return [
      {
        key: 'owasp',
        heading: this.intl.t('owasp'),
        title: this.intl.t('owaspExpansion'),
        contents: this.analysis.owasp.toArray(),
        hasContent:
          !isEmpty(this.analysis.owasp.toArray()) &&
          !this.owaspMobile2024Exists,
      },
      {
        key: 'owaspmobile2024',
        heading: this.intl.t('owaspmobile2024'),
        title: this.intl.t('owaspMobile2024Expansion'),
        contents: this.analysis.owaspmobile2024.toArray(),
        hasContent: this.owaspMobile2024Exists,
      },
      {
        key: 'owaspapi2023',
        heading: this.intl.t('owaspapi2023'),
        title: this.intl.t('owaspApiTop10Expansion'),
        contents: this.analysis.owaspapi2023.toArray(),
        hasContent: !isEmpty(this.analysis.owaspapi2023.toArray()),
      },
      {
        key: 'cwe',
        heading: this.intl.t('cwe'),
        title: this.intl.t('cweExpansion'),
        contents: this.analysis.cwe.toArray(),
        hasContent: !isEmpty(this.analysis.cwe.toArray()),
        component:
          'file-details/vulnerability-analysis-details/regulatory-content/cwe' as const,
      },
      {
        key: 'asvs',
        heading: this.intl.t('asvs'),
        title: this.intl.t('asvsExpansion'),
        contents: this.analysis.asvs.toArray(),
        hasContent: !isEmpty(this.analysis.asvs.toArray()),
      },
      {
        key: 'masvs',
        heading: this.intl.t('masvs'),
        title: this.intl.t('masvsExpansion'),
        contents: this.analysis.masvs.toArray(),
        hasContent: !isEmpty(this.analysis.masvs.toArray()),
      },
      {
        key: 'mstg',
        heading: this.intl.t('mstg'),
        title: this.intl.t('mstgExpansion'),
        contents: this.analysis.mstg.toArray(),
        hasContent: !isEmpty(this.analysis.mstg.toArray()),
      },
      {
        key: 'pcidss',
        heading: this.intl.t('pcidss'),
        title: this.intl.t('pcidssExpansion'),
        contents: this.analysis.pcidss.toArray(),
        hasContent: this.analysis.showPcidss && this.pcidssExists,
        hasMoreDetails: true,
      },
      {
        key: 'pcidss4',
        heading: this.intl.t('pcidss4'),
        title: this.intl.t('pcidssExpansion'),
        contents: this.analysis.pcidss4.toArray(),
        hasContent:
          this.analysis.showPcidss &&
          !isEmpty(this.analysis.pcidss4.toArray()) &&
          !this.pcidssExists,
        hasMoreDetails: true,
      },
      {
        key: 'hipaa',
        heading: this.intl.t('hipaa'),
        title: this.intl.t('hipaaExpansion'),
        contents: this.analysis.hipaa.toArray(),
        hasContent:
          this.analysis.showHipaa && !isEmpty(this.analysis.hipaa.toArray()),
        component:
          'file-details/vulnerability-analysis-details/regulatory-content/hipaa' as const,
      },
      {
        key: 'gdpr',
        heading: this.intl.t('gdpr'),
        title: this.intl.t('gdprExpansion'),
        contents: this.analysis.gdpr.toArray(),
        hasContent:
          this.analysis.showGdpr && !isEmpty(this.analysis.gdpr.toArray()),
      },
      {
        key: 'nistsp80053',
        heading: this.intl.t('nistsp80053'),
        title: this.intl.t('nistsp80053'),
        contents: this.analysis.nistsp80053.toArray(),
        hasContent:
          this.analysis.showNist &&
          !isEmpty(this.analysis.nistsp80053.toArray()),
        component:
          'file-details/vulnerability-analysis-details/regulatory-content/nist' as const,
      },
      {
        key: 'nistsp800171',
        heading: this.intl.t('nistsp800171'),
        title: this.intl.t('nistsp800171'),
        contents: this.analysis.nistsp800171.toArray(),
        hasContent:
          this.analysis.showNist &&
          !isEmpty(this.analysis.nistsp800171.toArray()),
        component:
          'file-details/vulnerability-analysis-details/regulatory-content/nist' as const,
      },
      {
        key: 'sama',
        heading: this.intl.t('sama'),
        title: this.intl.t('samaExpansion'),
        contents: this.analysis.sama.toArray(),
        hasContent:
          this.analysis.showSama && !isEmpty(this.analysis.sama.toArray()),
        hasMoreDetails: true,
      },
    ];
  }

  get hasRegulatoryContent() {
    return this.regulatoryContent.some((it) => it.hasContent);
  }

  get vulnerability() {
    return this.analysis.vulnerability || null;
  }

  get vulnerabilityTypes() {
    return this.analysis.vulnerabilityTypes;
  }

  get hasFindings() {
    return this.analysis.findings.length > 0;
  }

  get showSystemPassedFindings() {
    return this.analysis.isRiskPassedBySystem && this.hasFindings;
  }

  get vulnerabilityDescription() {
    if (this.analysis.isScanning) {
      return htmlSafe(this.vulnerability.get?.('question') || '');
    }

    if (
      this.analysis.isRisky ||
      this.analysis.isOverriddenAsPassed ||
      this.showSystemPassedFindings
    ) {
      return this.vulnerability.get?.('descriptionUnescapedd');
    }

    return htmlSafe(this.vulnerability.get?.('successMessage') || '');
  }

  get businessImplication() {
    return htmlSafe(this.vulnerability.get?.('businessImplication') || '');
  }

  get compliantSolution() {
    return htmlSafe(this.vulnerability.get?.('compliant') || '');
  }

  get nonCompliantCodeExample() {
    return htmlSafe(this.vulnerability.get?.('nonCompliant') || '');
  }
}

declare module '@glint/environment-ember-loose/registry' {
  export default interface Registry {
    'FileDetails::VulnerabilityAnalysisDetails': typeof FileDetailsVulnerabilityAnalysisDetailsComponent;
  }
}
